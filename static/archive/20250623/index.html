<html lang="en">
<head>
    <title>Geva Kipper - Celestial Portfolio</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <meta name="description" content="Geva Kipper's Celestial Portfolio - an interactive 3D solar system showcasing projects and skills.">
    
    <style>
        :root {
            --font-color: rgba(255, 255, 255, 0.9);
            --bg-color: #00000a;
            --card-bg-color: rgba(10, 15, 30, 0.85);
            --accent-color: #00ffff;
            --glow-color: #ffffff;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            color: var(--font-color);
            background-color: var(--bg-color);
            overflow: hidden;
        }

        #webgl-canvas {
            position: fixed;
            top: 0;
            left: 0;
            outline: none;
        }

        .ui-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        #header {
            position: absolute;
            top: 8vh;
            max-width: 600px;
            padding: 0 20px;
            transition: opacity 0.5s ease-in-out;
        }

        #header h1 {
            font-size: 3rem;
            font-weight: 300;
            margin: 0;
            letter-spacing: 2px;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        }

        #header p {
            font-size: 1.1rem;
            font-weight: 300;
            line-height: 1.6;
            margin: 10px 0;
        }

        #header .subtitle {
            font-size: 0.9rem;
            font-style: italic;
            opacity: 0.8;
            margin-top: 20px;
            animation: text-glimmer 8s infinite alternate;
        }
        
        @keyframes text-glimmer {
            0% { text-shadow: 0 0 2px rgba(0, 255, 255, 0.3); opacity: 0.8; }
            49% { text-shadow: 0 0 2px rgba(0, 255, 255, 0.3); opacity: 0.8; }
            50% { text-shadow: 0 0 10px rgba(255, 255, 255, 0.8); opacity: 1; }
            51% { text-shadow: 0 0 2px rgba(0, 255, 255, 0.3); opacity: 0.8; }
            100% { text-shadow: 0 0 2px rgba(0, 255, 255, 0.3); opacity: 0.8; }
        }

        #footer {
            position: absolute;
            bottom: 20px;
            width: 100%;
            text-align: center;
            font-size: 0.8rem;
            font-weight: 300;
            opacity: 0.6;
            transition: opacity 0.5s ease-in-out;
        }
        
        #footer::before {
            content: '';
            display: block;
            width: 200px;
            height: 1px;
            background: rgba(255, 255, 255, 0.2);
            margin: 0 auto 10px;
        }

        #celestial-label {
            position: absolute;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
            transform: translate(-50%, -150%);
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
            white-space: nowrap;
        }

        #project-card {
            position: absolute;
            top: 50%;
            right: 50px;
            transform: translateY(-50%);
            width: 350px;
            max-width: 90vw;
            background: var(--card-bg-color);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 25px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease-out, visibility 0.5s;
            pointer-events: all;
            text-align: left;
        }
        
        #project-card.visible {
            opacity: 1;
            visibility: visible;
        }

        #project-card h2 {
            margin-top: 0;
            font-weight: 400;
            color: var(--accent-color);
        }

        #project-card p {
            line-height: 1.6;
            font-size: 0.95rem;
        }

        .card-buttons {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .card-buttons a {
            flex-grow: 1;
            text-decoration: none;
            color: var(--font-color);
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            border-radius: 5px;
            text-align: center;
            transition: background 0.2s, color 0.2s;
            font-size: 0.9rem;
        }

        .card-buttons a:hover {
            background: var(--accent-color);
            color: var(--bg-color);
        }

        #close-card {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: color 0.2s;
        }
        #close-card:hover {
            color: var(--font-color);
        }
        
        #back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background: var(--card-bg-color);
            color: var(--font-color);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            pointer-events: all;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease-out, visibility 0.5s;
            backdrop-filter: blur(5px);
        }
        #back-button.visible {
            opacity: 1;
            visibility: visible;
        }
    </style>
</head>
<body>
    <div class="ui-container">
        <header id="header">
            <h1>Geva Kipper</h1>
            <p>Software Engineer at Google, crafting intelligent systems for global-scale products.</p>
            <p class="subtitle">This portfolio is a unique cosmic instance, algorithmically redesigned daily by AI.</p>
        </header>

        <footer id="footer">
            <p>Cosmos constructed by GPT-4. Time elapsed since genesis: <span id="stopwatch"></span></p>
        </footer>
        
        <div id="project-card">
            <button id="close-card" title="Close">&times;</button>
            <h2 id="card-title"></h2>
            <p id="card-description"></p>
            <div id="card-buttons" class="card-buttons"></div>
        </div>

        <button id="back-button">‚Üê Back to Solar System</button>
    </div>

    <div id="celestial-label"></div>

    <canvas id="webgl-canvas"></canvas>

    <!-- Modern ES6 module import using importmaps -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
    </script>
    
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        // --- DATA ------------------------------------------------------------------
        const projectData = {
            'glglstats': {
                title: 'GlglStats',
                description: 'A Python project measuring the repetitiveness of Israeli pop-chart songs using LZ77 compression, featuring interactive visualizations of lyrical patterns.',
                buttons: [
                    { text: 'Explore the Data', url: 'https://glglstats.onrender.com/' },
                    { text: 'Watch PyData Talk', url: 'https://www.youtube.com/watch?v=jrKAtOsj1Lo' }
                ]
            },
            'ahuzat-dibuk': {
                title: 'Ahuzat Dibuk',
                description: "A Python data project that scrapes and visualizes occupancy statistics for Tel-Aviv's public parking lots, generating predictive heatmaps for residents.",
                buttons: [
                    { text: 'As Seen on Channel 13', url: 'https://13tv.co.il/item/news/domestic/internal/parking-902956407/' },
                    { text: 'Mako Nexter Feature', url: 'https://www.mako.co.il/nexter-news/Article-ae43964b891bf71027.htm' },
                    { text: 'Original Facebook Post', url: 'https://www.facebook.com/groups/secrettelaviv/posts/10159636301195943' }
                ]
            },
            'part-orienter': {
                title: '2D Part Orienting',
                description: "A C++ implementation of an efficient algorithm that constructs a 'push plan' to orient any given polygon, contributed to an open-source computational geometry library.",
                buttons: [
                    { text: 'View Code & Algorithm', url: 'https://www.cgl.cs.tau.ac.il/projects/2d-part-orienting/' }
                ]
            },
            'portfolio': {
                title: 'The Celestial Portfolio',
                description: 'This very website. A self-referential, AI-generated, single-page portfolio built with modern web technologies to create an explorable universe of skills.',
                buttons: [
                    { text: 'View Source Orbit', url: 'https://portfolio-dor1.onrender.com/' }
                ]
            }
        };

        const socialData = {
            'github': { title: 'GitHub', url: 'https://github.com/gevak', icon: `data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0id2hpdGUiPjxwYXRoIGQ9Ik0xMiAwQzUuMzc0IDAgMCA1LjM3MyAwIDEyYzAgNS4zMDMgMy40MzggOS44IDguMjA3IDExLjM4Ny42LjExMS44Mi0uMjYxLjgyLS41Nzd2LTIuMDQyYzAgMCAwIDBjLTMuMzM4LjcyNC00LjAzMy0xLjQxNi00LjAzMy0xLjQxNi0uNTQ2LTEuMzg3LTEuMzM0LTEuNzU2LTEuMzM0LTEuNzU2LTEuMDkxLS43NDUuMDgyLS43My4wODItLjczIDEuMjA1LjA4NCAxLjgzOSAxLjIzNyAxLjgzOSAxLjIzNyAxLjA3IDEuODI5IDIuODE5IDEuMjk1IDMuNTA0Ljk5Mi4xMDgtLjc3Mi40MTgtMS4yOTUuNzYyLTEuNTk0LTIuNjc0LS4zMDQtNS40ODItMS4zMzItNS40ODItNS45MzEgMC0xLjMxMS40NjktMi4zOCAxLjIzNi0zLjIxMi0uMTI0LS4zMDMtLjUzNS0xLjUyNC4xMTctMy4xNzYgMCAwIDEuMDA4LS4zMjIgMy4zMDEgMS4yMy45NTgtLjI2NSAxLjk4My0uMzk4IDMuMDA0LS40MDQgMS4wMi4wMDYgMi4wNDYuMTM5IDMuMDA0LjQwNCAyLjI5MS0xLjU1MiAzLjMtMS4yMyAzLjMtMS4yMy42NTMgMS42NTIuMjQyIDIuODczLjEyMSAzLjE3Ni43NjguODMyIDEuMjM1IDEuOTA2IDEuMjM1IDMuMjEyIDAgNC42MTMtMi44MDggNS42MjQtNS40OTIgNS45Mi40My4zNzEuODIgMS4xMDIuODIgMi4yMTl2My4yOTVjMCAuMzE5LjIxOS42OTQuODE5LjU3NkMyMC41NjUgMjEuOCAyNCAxNy4zMDQgMjQgMTIgMjQgNS4zNzMgMTguNjI3IDAgMTIgMHoiLz48L3N2Zz4=`},
            'linkedin': { title: 'LinkedIn', url: 'https://linkedin.com/in/gevakip', icon: `data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0id2hpdGUiPjxwYXRoIGQ9Ik0yMC40NDcgMjAuNDUyaC0zLjU1NlYxNC44NWMwLTEuMzM4LS4wMjctMy4wNTEtMS44Ni0zLjA1MS0xLjg2MSAwLTIuMTQ0IDEuNDQ4LTIuMTQ0IDIuOTU0djUuNjk5SDkuMzExVjkuMDQ4aDMuNDI5djEuNTMxaC4wNDhjLjQ2NS0uODggMS42MDctMS44MjYgMy4zNzgtMS44MjYgMy42MTUgMCA0LjI4MiAyLjM3OCA0LjI4MiA1LjQ3MlYyMC40NTJ6TTUuMzA3IDcuNTM0Yy0xLjQ0NyAwLTIuNjIgMS4xNzUtMi42MiAyLjYxNyAwIDEuNDQ2IDEuMTczIDIuNjE4IDIuNjIgMi42MTggMS40NDUgMCAyLjYxOC0xLjE3MiAyLjYxOC0yLjYxOC0uMDAxLTEuNDQyLTEuMTczLTIuNjE3LTIuNjE4LTIuNjE3em0xLjc2MyAxMi45MThILS41NDRWOS4wNDhoNy4xMXYxMS40MDR6TTIyLjAwMSAwSDEuOTk4Qy44OTQgMCAwIC44OTUgMCAxLjk5NFYyMi4wMDZDIDAgMjMuMTA1Ljg5NCAyNCAxLjk5OCAyNEgyMi4wMDJD2My4xMDYgMjQgMjQgMjMuMTA1IDI0IDIyLjAwNlYxLjk5NEMyNCAuODk1IDIzLjEwNiAwIDIyLjAwMSAwdi0uMDAxeiIvPjwvc3ZnPg==` },
            'facebook': { title: 'Facebook', url: 'https://facebook.com/geva.kipper', icon: `data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0id2hpdGUiPjxwYXRoIGQ9Ik0yMi42NzUgMEgxLjMyNUMuNTkyIDAgMCAuNTkyIDAgMS4zMjV2MjEuMzVDMCAyMy40MDggLjU5MiAyNCAxLjMyNSAyNGgxMS40OTl2LTkuMjkySDkuNzAydi0zLjYyMmgzLjExNFY4LjQwMWMwLTMuMDg2IDEuODkyLTQuNzcgNC42NTktNC43NyAxLjMyNSAwIDIuNDYzLjA5OCAyLjc5NS4xNDN2My4yNGwtMS45MTguMDAxYy0xLjQ5MSAwLTEuNzc2LjcwNy0xLjc3NiAxLjc0N3YyLjMwN2gzLjU5bC0uNDY3IDMuNjIyaC0zLjEyM1YyNGg2LjEwN0MyMy40MDggMjQgMjQgMjMuNDA4IDI0IDIyLjY3NVYxLjMyNUMyNC41OTIgMjMuNDE3LjQxOCAyMi42NzUgMHoiLz48L3N2Zz4=`}
        };

        // --- GLOBAL VARS -------------------------------------------------------------
        let scene, camera, renderer, controls, composer;
        let sun, nebula;
        const planets = [];
        const asteroids = [];
        const celestialObjects = []; // for raycasting
        let activeFocusObject = null;
        let lastHovered = null;
        const originalCameraPos = new THREE.Vector3(0, 20, 45);

        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        
        // --- UI ELEMENTS -----------------------------------------------------------
        const headerEl = document.getElementById('header');
        const footerEl = document.getElementById('footer');
        const labelEl = document.getElementById('celestial-label');
        const projectCardEl = document.getElementById('project-card');
        const cardTitleEl = document.getElementById('card-title');
        const cardDescEl = document.getElementById('card-description');
        const cardButtonsEl = document.getElementById('card-buttons');
        const closeCardBtn = document.getElementById('close-card');
        const backButton = document.getElementById('back-button');

        // --- ANIMATION TWEENING ----------------------------------------------------
        let tween = { active: false };

        // --- INITIALIZATION -------------------------------------------------------
        function init() {
            setupScene();
            setupLights();
            setupPostProcessing();
            createStars();
            createNebula();
            createSun();
            createPlanets();
            createAsteroidBelt();
            setupControls();
            setupEventListeners();
            startStopwatch();
            animate();
        }

        // --- SCENE SETUP -----------------------------------------------------------
        function setupScene() {
            scene = new THREE.Scene();
            const canvas = document.getElementById('webgl-canvas');
            renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.copy(originalCameraPos);
        }

        function setupLights() {
            const ambientLight = new THREE.AmbientLight(0x4040ff, 0.4);
            scene.add(ambientLight);
        }
        
        function setupPostProcessing() {
            const renderPass = new RenderPass(scene, camera);
            const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
            bloomPass.threshold = 0;
            bloomPass.strength = 1.2;
            bloomPass.radius = 0.5;

            composer = new EffectComposer(renderer);
            composer.addPass(renderPass);
            composer.addPass(bloomPass);
        }

        // --- OBJECT CREATION -------------------------------------------------------
        function createStars() {
            const starVertices = [];
            for (let i = 0; i < 15000; i++) {
                const x = (Math.random() - 0.5) * 2000;
                const y = (Math.random() - 0.5) * 2000;
                const z = (Math.random() - 0.5) * 2000;
                const dist = x*x+y*y+z*z;
                if(dist < 200000) continue; // create a hole in the middle
                starVertices.push(x, y, z);
            }
            const starGeometry = new THREE.BufferGeometry();
            starGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starVertices, 3));
            const starMaterial = new THREE.PointsMaterial({ color: 0xffffff, size: 0.7, transparent: true, opacity: 0.8 });
            const stars = new THREE.Points(starGeometry, starMaterial);
            scene.add(stars);
        }

        function createNebula() {
            const nebulaGeo = new THREE.PlaneGeometry(500, 500);
            const nebulaMat = new THREE.ShaderMaterial({
                uniforms: {
                    time: { value: 1.0 },
                    resolution: { value: new THREE.Vector2() }
                },
                vertexShader: `
                    varying vec2 vUv;
                    void main() {
                        vUv = uv;
                        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                    }
                `,
                fragmentShader: `
                    uniform float time;
                    uniform vec2 resolution;
                    varying vec2 vUv;

                    float random (in vec2 _st) {
                        return fract(sin(dot(_st.xy, vec2(12.9898,78.233))) * 43758.5453123);
                    }

                    float noise (in vec2 _st) {
                        vec2 i = floor(_st);
                        vec2 f = fract(_st);
                        float a = random(i);
                        float b = random(i + vec2(1.0, 0.0));
                        float c = random(i + vec2(0.0, 1.0));
                        float d = random(i + vec2(1.0, 1.0));
                        vec2 u = f * f * (3.0 - 2.0 * f);
                        return mix(a, b, u.x) + (c - a)* u.y * (1.0 - u.x) + (d - b) * u.x * u.y;
                    }

                    #define NUM_OCTAVES 5
                    float fbm ( in vec2 _st) {
                        float v = 0.0;
                        float a = 0.5;
                        vec2 shift = vec2(100.0);
                        mat2 rot = mat2(cos(0.5), sin(0.5), -sin(0.5), cos(0.50));
                        for (int i = 0; i < NUM_OCTAVES; ++i) {
                            v += a * noise(_st);
                            _st = rot * _st * 2.0 + shift;
                            a *= 0.5;
                        }
                        return v;
                    }

                    void main() {
                        vec2 uv = (vUv - 0.5) * 5.0;
                        float t = time * 0.05;
                    
                        vec2 q = vec2(0.);
                        q.x = fbm( uv + 0.00*t );
                        q.y = fbm( uv + vec2(1.0));
                    
                        vec2 r = vec2(0.);
                        r.x = fbm( uv + 1.0*q + vec2(1.7,9.2)+ 0.15*t );
                        r.y = fbm( uv + 1.0*q + vec2(8.3,2.8)+ 0.126*t);
                    
                        float f = fbm(uv+r);
                    
                        vec3 color = mix(vec3(0.1, 0.0, 0.3), // Deep purple
                                         vec3(0.0, 0.2, 0.4), // Deep blue
                                         clamp((f*f)*4.0,0.0,1.0));
                    
                        color = mix(color,
                                    vec3(0.0, 0.5, 0.6), // Cyan highlights
                                    clamp(length(q),0.0,1.0));
                    
                        color = mix(color,
                                    vec3(0.9, 0.9, 1.0), // Hint of white
                                    clamp(length(r.x),0.0,1.0));
                    
                        gl_FragColor = vec4((f*f*f+.6*f*f+.5*f)*color, 1.0);
                    }
                `,
                transparent: true,
                depthWrite: false,
            });
            nebula = new THREE.Mesh(nebulaGeo, nebulaMat);
            nebula.position.z = -200;
            scene.add(nebula);
        }
        
        function createSun() {
            const sunGeometry = new THREE.SphereGeometry(4, 32, 32);
            const sunMaterial = new THREE.MeshBasicMaterial({ color: 0xffddaa });
            sun = new THREE.Mesh(sunGeometry, sunMaterial);
            sun.name = "Geva Kipper";
            celestialObjects.push(sun);

            const pointLight = new THREE.PointLight(0xffddaa, 2, 200, 2);
            pointLight.position.set(0, 0, 0);
            sun.add(pointLight);
            scene.add(sun);
        }

        function createPlanets() {
            const planetSpecs = [
                { name: 'glglstats', orbitRadius: 10, size: 1, speed: 0.005, type: 'waveform' },
                { name: 'ahuzat-dibuk', orbitRadius: 18, size: 1.2, speed: 0.003, type: 'city' },
                { name: 'part-orienter', orbitRadius: 36, size: 0.9, speed: 0.0015, type: 'crystal' },
                { name: 'portfolio', orbitRadius: 50, size: 1.1, speed: 0.001, type: 'mirror' },
            ];

            planetSpecs.forEach(spec => {
                let planet;
                const pivot = new THREE.Object3D();
                scene.add(pivot);

                if (spec.type === 'waveform') {
                    const geometry = new THREE.SphereGeometry(spec.size, 32, 32);
                    const material = new THREE.ShaderMaterial({
                        uniforms: {
                            time: { value: 0.0 },
                            color: { value: new THREE.Color(0x00ffff) }
                        },
                        vertexShader: `
                            uniform float time;
                            varying float noise;
                            void main() {
                                noise = 1.0 + 0.2 * sin(uv.y * 20.0 + time * 5.0) + 0.1 * sin(uv.x * 15.0 + time * 3.0);
                                vec3 newPosition = position * noise;
                                gl_Position = projectionMatrix * modelViewMatrix * vec4(newPosition, 1.0);
                            }
                        `,
                        fragmentShader: `
                            uniform vec3 color;
                            varying float noise;
                            void main() {
                                gl_FragColor = vec4(color * (noise - 0.5), 1.0);
                            }
                        `
                    });
                    planet = new THREE.Mesh(geometry, material);
                } else if (spec.type === 'city') {
                    const geometry = new THREE.SphereGeometry(spec.size, 32, 32);
                    const material = new THREE.ShaderMaterial({
                         uniforms: { time: { value: 0.0 } },
                         vertexShader: `varying vec3 vNormal; void main() { vNormal = normalize( normalMatrix * normal ); gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 ); }`,
                         fragmentShader: `
                            uniform float time;
                            varying vec3 vNormal;
                            float grid(vec2 st, float res){ return 1.0-floor(st.x*res)/res; }
                            void main() {
                              vec3 view_nv = normalize(vNormal);
                              float intensity = pow( 0.7 - dot( vNormal, vec3(0.0,0.0,1.0) ), 2.0 );
                              vec2 uv = vec2(atan(view_nv.x,view_nv.z)/6.28318530718,acos(view_nv.y)/3.14159265359);
                              vec3 col = vec3(0.0);
                              float heat = sin(uv.y * 30.0 + time) * 0.5 + 0.5;
                              vec3 color1 = vec3(0.1, 0.2, 0.9); vec3 color2 = vec3(0.9, 0.2, 0.1);
                              vec3 cityColor = mix(color1, color2, heat) * 0.8;
                              float light = smoothstep(0.99, 1.0, grid(uv, 50.0) * grid(vec2(uv.y, uv.x), 70.0));
                              col += light * cityColor;
                              gl_FragColor = vec4(col,1.0);
                            }
                        `
                    });
                    planet = new THREE.Mesh(geometry, material);
                } else if (spec.type === 'crystal') {
                    const geometry = new THREE.IcosahedronGeometry(spec.size, 0);
                    const material = new THREE.MeshStandardMaterial({
                        color: 0xcccccc,
                        metalness: 0.9,
                        roughness: 0.2,
                        flatShading: true
                    });
                    planet = new THREE.Mesh(geometry, material);
                } else if (spec.type === 'mirror') {
                     const cubeRenderTarget = new THREE.WebGLCubeRenderTarget(256, {
                        format: THREE.RGBFormat,
                        generateMipmaps: true,
                        minFilter: THREE.LinearMipmapLinearFilter
                    });
                    const cubeCamera = new THREE.CubeCamera(0.1, 1000, cubeRenderTarget);
                    const geometry = new THREE.SphereGeometry(spec.size, 32, 32);
                    const material = new THREE.MeshStandardMaterial({
                        envMap: cubeRenderTarget.texture,
                        metalness: 1.0,
                        roughness: 0.1,
                    });
                    const wireframeGeo = new THREE.SphereGeometry(spec.size * 1.01, 32, 32);
                    const wireframeMat = new THREE.MeshBasicMaterial({ color: 0x00ffff, wireframe: true, transparent: true, opacity: 0.2 });
                    
                    planet = new THREE.Mesh(geometry, material);
                    planet.add(new THREE.Mesh(wireframeGeo, wireframeMat));
                    planet.cubeCamera = cubeCamera;
                }

                planet.name = projectData[spec.name].title;
                planet.userData = { id: spec.name, pivot, orbitRadius: spec.orbitRadius, speed: spec.speed, isPlanet: true, size: spec.size };
                planet.position.x = spec.orbitRadius;
                pivot.add(planet);
                planets.push(planet);
                celestialObjects.push(planet);
            });
        }
        
        function createAsteroidBelt() {
            const beltRadius = 26;
            const socialKeys = Object.keys(socialData);
            for(let i = 0; i < socialKeys.length; i++) {
                const key = socialKeys[i];
                const social = socialData[key];

                const pivot = new THREE.Object3D();
                scene.add(pivot);

                const size = 0.3 + Math.random() * 0.3;
                const geometry = new THREE.IcosahedronGeometry(size, 1);
                const pos = geometry.attributes.position;
                for (let j = 0; j < pos.count; j++) {
                    const v = new THREE.Vector3().fromBufferAttribute(pos, j);
                    v.setLength(size + (Math.random() - 0.5) * size * 0.5);
                    pos.setXYZ(j, v.x, v.y, v.z);
                }
                geometry.computeVertexNormals();
                const material = new THREE.MeshStandardMaterial({ color: 0x888888, roughness: 0.8 });
                const asteroid = new THREE.Mesh(geometry, material);

                const angle = (i / socialKeys.length) * Math.PI * 2 + Math.random() * 0.5;
                asteroid.position.set(beltRadius * Math.cos(angle), (Math.random()-0.5) * 2, beltRadius * Math.sin(angle));
                
                // Add icon sprite
                const texture = new THREE.TextureLoader().load(social.icon);
                const spriteMat = new THREE.SpriteMaterial({ map: texture, color: 0xffffff, transparent: true, opacity: 0.7, depthTest: false, depthWrite: false });
                const sprite = new THREE.Sprite(spriteMat);
                sprite.scale.set(1, 1, 1);
                sprite.visible = false;
                asteroid.add(sprite);

                asteroid.name = social.title;
                asteroid.userData = { id: key, url: social.url, speed: 0.0025, isAsteroid: true, sprite};
                pivot.add(asteroid);
                asteroids.push(asteroid);
                celestialObjects.push(asteroid);
            }
        }

        // --- CONTROLS & EVENTS -----------------------------------------------------
        function setupControls() {
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.screenSpacePanning = false;
            controls.minDistance = 5;
            controls.maxDistance = 100;
            controls.maxPolarAngle = Math.PI / 2 + 0.3;
            controls.minPolarAngle = Math.PI / 2 - 0.9;
            controls.target.set(0, 0, 0);
        }

        function setupEventListeners() {
            window.addEventListener('resize', onWindowResize);
            window.addEventListener('mousemove', onMouseMove);
            window.addEventListener('click', onClick);
            closeCardBtn.addEventListener('click', returnToSolarSystem);
            backButton.addEventListener('click', returnToSolarSystem);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        }

        function onMouseMove(event) {
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = - (event.clientY / window.innerHeight) * 2 + 1;

            if (activeFocusObject) return;

            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(celestialObjects);

            if (intersects.length > 0) {
                const object = intersects[0].object;
                if (lastHovered !== object) {
                    clearHoverEffects();
                    lastHovered = object;
                    document.body.style.cursor = 'pointer';

                    if (object.material.emissive) {
                        object.userData.originalEmissive = object.material.emissive.getHex();
                        object.material.emissive.setHex(0xffffff);
                    }
                    if (object.userData.isAsteroid) {
                        object.userData.sprite.visible = true;
                    }

                    labelEl.textContent = object.name;
                    labelEl.style.opacity = '1';
                }
                const screenPos = toScreenPosition(object, camera);
                labelEl.style.left = `${screenPos.x}px`;
                labelEl.style.top = `${screenPos.y}px`;

            } else {
                if (lastHovered) {
                    clearHoverEffects();
                    lastHovered = null;
                }
                document.body.style.cursor = 'default';
                labelEl.style.opacity = '0';
            }
        }
        
        function clearHoverEffects() {
            if (!lastHovered) return;
            if (lastHovered.material.emissive && lastHovered.userData.originalEmissive !== undefined) {
                lastHovered.material.emissive.setHex(lastHovered.userData.originalEmissive);
            }
            if (lastHovered.userData.isAsteroid) {
                lastHovered.userData.sprite.visible = false;
            }
        }

        function onClick(event) {
            if (tween.active || projectCardEl.classList.contains('visible')) return;
        
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(celestialObjects);
        
            if (intersects.length > 0) {
                const object = intersects[0].object;
                if (object.userData.isPlanet) {
                    focusOnObject(object);
                } else if (object.userData.isAsteroid) {
                    window.open(object.userData.url, '_blank');
                }
            }
        }
        
        function focusOnObject(object) {
            activeFocusObject = object;
            
            const worldPos = new THREE.Vector3();
            object.getWorldPosition(worldPos);

            const offset = new THREE.Vector3(0, object.userData.size * 0.5, object.userData.size * 4);
            const targetCamPos = worldPos.clone().add(offset);
            
            tween = {
                active: true,
                startCamPos: camera.position.clone(),
                targetCamPos: targetCamPos,
                startTarget: controls.target.clone(),
                targetTarget: worldPos,
                alpha: 0
            };
            
            controls.enabled = false;
            headerEl.style.opacity = 0;
            footerEl.style.opacity = 0;
            labelEl.style.opacity = 0;
            backButton.classList.add('visible');
        }

        function returnToSolarSystem() {
            if (tween.active) return;
            activeFocusObject = null;
            
            tween = {
                active: true,
                startCamPos: camera.position.clone(),
                targetCamPos: originalCameraPos,
                startTarget: controls.target.clone(),
                targetTarget: new THREE.Vector3(0,0,0),
                alpha: 0
            };
            
            projectCardEl.classList.remove('visible');
            backButton.classList.remove('visible');
            setTimeout(() => {
                headerEl.style.opacity = 1;
                footerEl.style.opacity = 1;
                controls.enabled = true;
            }, 500);
        }
        
        function updateTween(delta) {
            if (!tween.active) return;
            
            tween.alpha += delta * 1.5; // speed
            if (tween.alpha >= 1) {
                tween.alpha = 1;
                tween.active = false;
                camera.position.copy(tween.targetCamPos);
                controls.target.copy(tween.targetTarget);
                
                if (activeFocusObject) {
                    camera.lookAt(activeFocusObject.position);
                    showProjectCard(activeFocusObject.userData.id);
                }
            } else {
                const easeAlpha = 0.5 * (1 - Math.cos(Math.PI * tween.alpha));
                camera.position.lerpVectors(tween.startCamPos, tween.targetCamPos, easeAlpha);
                controls.target.lerpVectors(tween.startTarget, tween.targetTarget, easeAlpha);
            }
        }

        // --- UI LOGIC --------------------------------------------------------------
        function toScreenPosition(obj, cam) {
            const vector = new THREE.Vector3();
            const widthHalf = 0.5 * renderer.domElement.width;
            const heightHalf = 0.5 * renderer.domElement.height;
            
            obj.updateMatrixWorld();
            vector.setFromMatrixPosition(obj.matrixWorld);
            vector.project(cam);
            
            vector.x = (vector.x * widthHalf) + widthHalf;
            vector.y = - (vector.y * heightHalf) + heightHalf;
            
            return { x: vector.x, y: vector.y };
        }
        
        function showProjectCard(id) {
            const data = projectData[id];
            cardTitleEl.textContent = data.title;
            cardDescEl.textContent = data.description;
            cardButtonsEl.innerHTML = '';
            data.buttons.forEach(btn => {
                const a = document.createElement('a');
                a.href = btn.url;
                a.target = '_blank';
                a.rel = 'noopener noreferrer';
                a.textContent = btn.text;
                cardButtonsEl.appendChild(a);
            });
            projectCardEl.classList.add('visible');
        }

        function startStopwatch() {
            const stopwatchElement = document.getElementById('stopwatch');
            const genesisDate = new Date('2025-06-23T01:12:28Z').getTime();

            function updateTimer() {
                const now = Date.now();
                const diff = now - genesisDate;

                if (diff < 0) {
                    stopwatchElement.textContent = `Awaiting genesis...`;
                    return;
                }
                
                const s = Math.floor(diff / 1000);
                const m = Math.floor(s / 60);
                const h = Math.floor(m / 60);
                const d = Math.floor(h / 24);

                const ds = d;
                const hs = h % 24;
                const ms = m % 60;
                const ss = s % 60;

                const pad = (num) => num.toString().padStart(2, '0');
                stopwatchElement.textContent = `${pad(ds)}d ${pad(hs)}h ${pad(ms)}m ${pad(ss)}s`;
            }
            updateTimer();
            setInterval(updateTimer, 1000);
        }
        
        // --- ANIMATION LOOP --------------------------------------------------------
        const clock = new THREE.Clock();
        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();
            
            updateTween(delta);
            
            // Sun pulsation
            const pulse = Math.sin(clock.getElapsedTime() * 1.5) * 0.05 + 1;
            sun.scale.set(pulse, pulse, pulse);

            // Animate planets
            planets.forEach(p => {
                const userData = p.userData;
                userData.pivot.rotation.y += userData.speed * 0.5; // Orbit
                p.rotation.y += 0.005; // Self-rotation

                if(p.material.uniforms && p.material.uniforms.time) {
                    p.material.uniforms.time.value = clock.getElapsedTime();
                }
                if(p.userData.id === 'part-orienter'){
                    p.rotation.x += 0.002;
                    p.rotation.z += 0.002;
                }
                if (p.cubeCamera) {
                    p.visible = false;
                    p.cubeCamera.position.copy(p.getWorldPosition(new THREE.Vector3()));
                    p.cubeCamera.update(renderer, scene);
                    p.visible = true;
                }
            });
            
            // Animate asteroids
            asteroids.forEach(a => {
                a.userData.pivot.rotation.y += a.userData.speed * 0.5;
                a.rotation.x += 0.01;
                a.rotation.y += 0.01;
            });

            // Animate nebula
            if (nebula.material.uniforms.time) {
                nebula.material.uniforms.time.value = clock.getElapsedTime();
            }

            if(controls.enabled) controls.update();
            composer.render();
        }

        init();
    </script>
<!-- Add this block to embed the like button -->
    <script src="/static/js/like_button.js"></script>
    <script>
        LikeButton.init({
          pageId: "20250623",
          position: "bottom-right", // Options: bottom-right, bottom-left, top-right, top-left
        });
    </script>

</body>
</html>